name: CI/CD Pipeline

on:
  push:
    branches:
      - cicd
  pull_request:
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'
  DOCKER_BUILDKIT: 1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: admin
          RABBITMQ_DEFAULT_PASS: admin
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672
      
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install shared package
        working-directory: ./shared
        run: |
          pip install --upgrade pip
          pip install -e .

      - name: Install service dependencies
        run: |
          pip install -r auth-service/requirements.txt -r auth-service/requirements-dev.txt
          pip install -r order-service/requirements.txt -r order-service/requirements-dev.txt
          pip install -r product-service/requirements.txt -r product-service/requirements-dev.txt
          pip install -r notification-service/requirements.txt -r notification-service/requirements-dev.txt

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run auth-service tests
        working-directory: ./auth-service
        env:
          APP_NAME: TheOne
          ENVIRONMENT: test
          DEBUG: "false"
          LOG_LEVEL: INFO
          SERVICE_NAME: auth-service
          JSON_OUTPUT: "false"
          LOG_FILE: ""
          JWT_SECRET_KEY: your-secret-key-change-in-test
          JWT_ALGORITHM: HS256
          ACCESS_TOKEN_EXPIRE_MINUTES: 30
          REFRESH_TOKEN_EXPIRE_DAYS: 7
          POSTGRES_AUTH_URL: postgresql://postgres:postgres@localhost:5432/theone_auth_db
          POSTGRES_AUTH_POOL_SIZE: 5
          POSTGRES_AUTH_MAX_OVERFLOW: 10
          POSTGRES_AUTH_POOL_TIMEOUT: 30  
          REDIS_URL: redis://localhost:6379
          REDIS_DECODE_RESPONSES: "true"
          REDIS_SOCKET_TIMEOUT: 5
          REDIS_SOCKET_CONNECT_TIMEOUT: 5
        run: |
          # Create test database
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE theone_auth_db;" || true
          # Run migrations
          alembic upgrade head || true
          # Run tests
          pytest

      - name: Run order-service tests
        working-directory: ./order-service
        env:
          APP_NAME: TheOne
          ENVIRONMENT: test
          DEBUG: "false"
          LOG_LEVEL: INFO
          SERVICE_NAME: order-service
          JSON_OUTPUT: "false"
          LOG_FILE: ""
          JWT_SECRET_KEY: your-secret-key-change-in-test
          JWT_ALGORITHM: HS256
          ACCESS_TOKEN_EXPIRE_MINUTES: 30
          REFRESH_TOKEN_EXPIRE_DAYS: 7
          POSTGRES_ORDER_URL: postgresql://postgres:postgres@localhost:5432/theone_order_db
          POSTGRES_ORDER_POOL_SIZE: 5
          POSTGRES_ORDER_MAX_OVERFLOW: 10
          POSTGRES_ORDER_POOL_TIMEOUT: 30
          REDIS_URL: redis://localhost:6379
          REDIS_DECODE_RESPONSES: "true"
          REDIS_SOCKET_TIMEOUT: 5
          REDIS_SOCKET_CONNECT_TIMEOUT: 5
          RABBITMQ_URL: amqp://admin:admin@localhost:5672/
          RABBITMQ_EXCHANGE: ecommerce.events
          RABBITMQ_QUEUE_PREFIX: theone
          RABBITMQ_PREFETCH_COUNT: 10
        run: |
          # Create test database
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE theone_order_db;" || true
          # Run migrations
          alembic upgrade head || true
          # Run tests
          pytest

      - name: Run product-service tests
        working-directory: ./product-service
        env:
          APP_NAME: TheOne
          ENVIRONMENT: test
          DEBUG: "false"
          LOG_LEVEL: INFO
          SERVICE_NAME: product-service
          JSON_OUTPUT: "false"
          LOG_FILE: ""
          JWT_SECRET_KEY: your-secret-key-change-in-test
          JWT_ALGORITHM: HS256
          ACCESS_TOKEN_EXPIRE_MINUTES: 30
          REFRESH_TOKEN_EXPIRE_DAYS: 7
          MONGODB_URL: mongodb://admin:admin@localhost:27017/theone_db?authSource=admin
          MONGODB_DATABASE: theone_db
          REDIS_URL: redis://localhost:6379
          REDIS_DECODE_RESPONSES: "true"
          REDIS_SOCKET_TIMEOUT: 5
          REDIS_SOCKET_CONNECT_TIMEOUT: 5
          RABBITMQ_URL: amqp://admin:admin@localhost:5672/
          RABBITMQ_EXCHANGE: ecommerce.events
          RABBITMQ_QUEUE_PREFIX: theone
          RABBITMQ_PREFETCH_COUNT: 10
        run: |
          # Run tests
          pytest

      - name: Run notification-service tests
        working-directory: ./notification-service
        env:
          APP_NAME: TheOne
          ENVIRONMENT: test
          DEBUG: "false"
          LOG_LEVEL: INFO
          SERVICE_NAME: notification-service
          JSON_OUTPUT: "false"
          LOG_FILE: ""
          JWT_SECRET_KEY: your-secret-key-change-in-test
          JWT_ALGORITHM: HS256
          ACCESS_TOKEN_EXPIRE_MINUTES: 30
          REFRESH_TOKEN_EXPIRE_DAYS: 7
          REDIS_URL: redis://localhost:6379
          REDIS_DECODE_RESPONSES: "true"
          REDIS_SOCKET_TIMEOUT: 5
          REDIS_SOCKET_CONNECT_TIMEOUT: 5
          RABBITMQ_URL: amqp://admin:admin@localhost:5672/
          RABBITMQ_EXCHANGE: ecommerce.events
          RABBITMQ_QUEUE_PREFIX: notification-service
          RABBITMQ_PREFETCH_COUNT: 10
        run: |
          # Run tests
          pytest

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/cicd'
    permissions:
      contents: read
      packages: write   

    strategy:
      matrix:
        service:
          - auth-service
          - notification-service
          - order-service
          - product-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: false
          tags: theone-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Login to Container Registry (GITHUB_TOKEN)
        if: vars.USE_CR_PAT != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Container Registry (PAT)
        if: vars.USE_CR_PAT == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ vars.GHCR_USERNAME || github.actor }}
          password: ${{ secrets.CR_PAT }}
      
      - name: Push Docker image for ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/${{ matrix.service }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-notification-worker:
    name: Build Notification Worker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/cicd'
    permissions:
      contents: read
      packages: write   

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for notification-worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./notification-service/Dockerfile.worker
          push: false
          tags: theone-notification-worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Check code formatting with black
        run: |
          black --check --diff auth-service/ order-service/ product-service/ notification-service/ shared/ || true

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff auth-service/ order-service/ product-service/ notification-service/ shared/ || true

      - name: Lint with flake8
        run: |
          flake8 auth-service/ order-service/ product-service/ notification-service/ shared/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 auth-service/ order-service/ product-service/ notification-service/ shared/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true

  # deploy:
  #   name: Deploy to Production
  #   runs-on: ubuntu-latest
  #   needs: [build, build-notification-worker]
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/cicd'
    # environment:
      # name: production
      # url: https://your-production-url.com
  #
  #   steps:
  #     - name: Deploy
  #       env:
  #         GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  #         ENVIRONMENT: production
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Deploy to server
  #       run: |
  #         echo "Add your deployment steps here"
  #         # Example: SSH into server and run docker-compose up -d
  #         # Or use a deployment tool like Ansible, Terraform, etc.
